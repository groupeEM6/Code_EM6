#include <SPI.h>

// Sur Nano Every : 
// Serial  = Moniteur série USB (ton clavier)
// Serial1 = Module Bluetooth HC-05 (ton retour sans fil)
#define bluetooth Serial1 

int board[9] = {0}; // 0=vide, 1=humain, -1=robot

// --- FONCTIONS LOGIQUES (Calcul du jeu) ---

int gagnant(int b[9]) {
    const int L[8][3] = {{0,1,2},{3,4,5},{6,7,8},{0,3,6},{1,4,7},{2,5,8},{0,4,8},{2,4,6}};
    for (int i = 0; i < 8; i++) {
        if (b[L[i][0]] != 0 && b[L[i][0]] == b[L[i][1]] && b[L[i][1]] == b[L[i][2]]) return b[L[i][0]];
    }
    return 0;
}

int minimax(int b[9], int joueur) {
    int win = gagnant(b);
    if (win == -1) return 1;
    if (win == 1) return -1;
    
    bool plein = true;
    for(int i=0; i<9; i++) if(b[i]==0) plein = false;
    if(plein) return 0;

    int meilleur = (joueur == -1 ? -1000 : 1000);
    for (int i = 0; i < 9; i++) {
        if (b[i] == 0) {
            b[i] = joueur;
            int score = minimax(b, -joueur);
            b[i] = 0;
            if (joueur == -1) meilleur = max(meilleur, score);
            else meilleur = min(meilleur, score);
        }
    }
    return meilleur;
}

int calculerMeilleurCoup() {
    int meilleurScore = -1000;
    int coup = -1;
    for (int i = 0; i < 9; i++) {
        if (board[i] == 0) {
            board[i] = -1;
            int score = minimax(board, 1);
            board[i] = 0;
            if (score > meilleurScore) {
                meilleurScore = score;
                coup = i;
            }
        }
    }
    return coup;
}

// --- INITIALISATION ---

void setup() {
    Serial.begin(9600);    // Port USB
    bluetooth.begin(9600); // Port HC-05
    
    Serial.println("--- TEST ROBOT OXO ---");
    Serial.println("Tapez un chiffre entre 0 et 8 pour simuler un coup :");
    bluetooth.println("Liaison Bluetooth active.");
}

// --- BOUCLE PRINCIPALE ---

void loop() {
    // 1. Lire ce que TU tapes sur ton clavier (PC -> Arduino via USB)
    if (Serial.available() > 0) {
        // On lit le caractère, on le convertit en chiffre
        int coupAdversaire = Serial.parseInt(); 

        // Vérification si la case est valide
        if (coupAdversaire >= 0 && coupAdversaire <= 8) {
            if (board[coupAdversaire] == 0) {
                
                // On enregistre ton coup
                board[coupAdversaire] = 1;
                Serial.print("Vous avez joue en : ");
                Serial.println(coupAdversaire);

                // 2. Le robot réfléchit
                int coupRobot = calculerMeilleurCoup();

                if (coupRobot != -1) {
                    board[coupRobot] = -1;

                    // 3. ENVOI DU RÉSULTAT PAR BLUETOOTH (Arduino -> PC via HC-05)
                    bluetooth.print("Strategie : Je vais jouer la case ");
                    bluetooth.println(coupRobot);
                    
                    // On l'affiche aussi sur l'USB pour comparer
                    Serial.print("Le robot repond (via Bluetooth) : ");
                    Serial.println(coupRobot);
                }
            } else {
                Serial.println("Erreur : Case deja occupee !");
            }
        }
        
        // Vérification fin de partie
        int res = gagnant(board);
        if (res != 0 || calculerMeilleurCoup() == -1) {
            String fin = (res == -1) ? "Robot gagne !" : (res == 1 ? "Tu gagnes !" : "Match nul.");
            bluetooth.println(fin);
            Serial.println(fin);
            // Reset du plateau pour rejouer
            for(int i=0; i<9; i++) board[i] = 0;
            Serial.println("\n--- Nouvelle Partie ---");
        }
    }
}
